<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="CoffeeCup HTML Editor (www.coffeecup.com)">
    <meta name="dcterms.created" content="lun, 20 feb 2017 17:46:37 GMT">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <title></title>

    <!--[if IE]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
<!DOCTYPE html>
<html>
    <head>
        <title>MAPA</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="initial-scale = 1, user-scalable = no">

        <!--LIBRERIAS COMUNES -->
        <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
        <link rel="stylesheet" href="https://bootswatch.com/superhero/bootstrap.min.css">
        <link href="scripts/nv.css" rel="stylesheet">

        <!-- include cartodb.js library -->
        <script src="scripts/d3.js" charset="utf-8"></script>
        <script src="scripts/nv.js"></script>
        <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>

        <!--ESTILO  -->
        <style>
            html,
            body,
            #map {
                height: 100%;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .container-fluid .row > div{
                height: 100vh;
            }
            #chart_pob {
                height: 300px;
                width: 100%;
            }
            #chart_concern{
                height: 400px;
                width: 100%;
            }
            #thematic button{
                border: 1px solid #2b3e50;
            }
            #thematic .row {
                margin: 0 5px;
            }
            div.cartodb-legend{
                left:25px;
                right:inherit;
            }
           .nvd3 .nv-x text,
           .nvd3 .nv-y text,
           .nvd3 .nv-legend text{
                fill: white;
            }
        </style>

        <!-- Buscar auto completar -->
        <script>
        </script>
    </head>
    <body>

        <div class="container-fluid">
        <div class="row">
            <div class="col-md-2">
                <h1>Smart Cityzens</h1>
                <h4>Temáticos</h4>
                <div id="thematic" class="form-group">
                    <div class="row">
                        <button type="button" id="Capa1" class="col-md-6 btn btn-default">ICC</button>
                        <button type="button" id="Capa2" class="col-md-6 btn btn-default">Paro</button>
                    </div>
                    <div class="row">
                        <button type="button" id="Capa3" class="col-md-6 btn btn-default">Jóvenes</button>
                        <button type="button" id="Capa4" class="col-md-6 btn btn-default">Voto'16</button>
                    </div>
                </div>

                <!-- DIV SELECTORES-->
                <div id="selector_menu" class="form-horizontal">
                    <h4>Filtro geográfico</h4>
                    <div class="form-group">
                        <label class="control-label col-md-4">Provincias</label>
                        <div class="col-md-8">
                        <select id="province_selector" class="form-control">
                            <option value="A Coruña','Lugo','Pontevedra','Ourense">Todas</option>
                        </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-4">Municipios</label>
                        <div class="col-md-8">
                        <select id="municipality_selector" class="form-control"> </select>
                        </div>
                    </div>
                    <h4>Filtro Prospección</h4>
                    <div class="form-group">
                        <label class="control-label col-md-4">Población</label>
                        <div class="col-md-8">
                            <select id="poblacion_selector" class="form-control"> </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-4">Vulnerabilidad</label>
                        <div class="col-md-8">
                            <select id="vulnera_selector" class="form-control"> </select>
                        </div>
                    </div>
                </div>


                <!-- LEYENDA -->
                <div class='cartodb-legend density' style="display: none;" id="legend1">
                    <div class="legend-title" style="color:#284a59">Ind. Confianza Ciudadano</div>
                    <ul>
                        <li class="min"> Muy Baja </li>
                        <li class="max"> Muy Alta </li>

                        <li class="graph leg" style="border-radius: 0; border:none">
                            <div class="colors">
                                <div class="quartile" style="background-color:#F50024"></div>
                                <div class="quartile" style="background-color:#F53D36"></div>
                                <div class="quartile" style="background-color:#F57A40"></div>
                                <div class="quartile" style="background-color:#F5B869"></div>
                                <div class="quartile" style="background-color:#F5F514"></div>
                             </div>
                             <div class="colors" style="font-weight:normal; text-align: center">
                                <div class="quartile" style="padding-top: 5px"></div>
                                <div class="quartile" style="padding-top: 5px"></div>
                                <div class="quartile" style="padding-top: 5px"></div>
                                <div class="quartile" style="padding-top: 5px"></div>
                                <div class="quartile" style="padding-top: 5px"></div>
                             </div>
                        </li>
                    </ul>
                </div>

                <div class='cartodb-legend density' style="display: none;" id="legend2">
                    <div class="legend-title" style="color:#284a59">Ind. Paro</div>
                    <ul>
                        <li class="min"> Muy Bajo </li>
                        <li class="max"> Muy Alto </li>
                        <li class="graph leg" style="border-radius: 0; border:none">
                            <div class="colors">
                                <div class="quartile" style="background-color:#ecda9a"></div>
                                <div class="quartile" style="background-color:#f3ad6a"></div>
                                <div class="quartile" style="background-color:#f97b57"></div>
                                <div class="quartile" style="background-color:#ee4d5a"></div>
                             </div>
                             <div class="colors" style="font-weight:normal; text-align: center">
                                <div class="quartile" style="padding-top: 5px"></div>
                                <div class="quartile" style="padding-top: 5px"></div>
                                <div class="quartile" style="padding-top: 5px"></div>
                                <div class="quartile" style="padding-top: 5px"></div>
                             </div>
                        </li>
                    </ul>
                </div>
                <div class='cartodb-legend category' style="display: none;" id="legend3">
                    <div class="legend-title" style="color:#284a59">Jovenes</div>
                    <ul>
                        <li><div class="bullet" style="background-color:#191970"></div>JOVEN</li>
                        <li><div class="bullet" style="background-color:#ADD8E6"></div>NO JOVEN</li>
                    </ul>
                </div>
                <div class='cartodb-legend category' style="display: none;" id="legend4">
                    <div class="legend-title" style="color:#284a59">Voto Mayoritario '16</div>
                    <ul>
                        <li><div class="bullet" style="background-color:#00C5FF"></div>PP</li>
                        <li><div class="bullet" style="background-color:#FF0000"></div>PSOE</li>
                        <li><div class="bullet" style="background-color:#C500FF"></div>MAREAS</li>
                        <li><div class="bullet" style="background-color:#004DA8"></div>BNG</li>
                    </ul>
                </div>
            </div>
            <div class="col-md-7">
                <div id="map"></div>
            </div>
            <div id="charts" class="col-md-3">
                <!-- GRAFICAS -->
                <div class="row">
                    <h4>Población</h4>
                </div>
                <div class="row">
                    <div id="chart_pob" class="col-md-12"></div>
                </div>
                <div class="row">
                    <h4>Preocupaciones</h4>
                </div>
                <div class="row">
                    <div id="chart_concern" class="col-md-12"></div>
                </div>
            </div>
        </div>
        </div>

        <script>

        // GLOBALES

        var sql = new cartodb.SQL({ user: 'minsait' });
        var table_name = "test_data";
        var provinces = [];
        var municipalities = [];
        var geo_filter = {
            ds_prov: false,
            ds_muni: false,
            pb_esjoven: false,
            vulne1: false
        };
        var sublayer;
        var nvChart;
        var concern_averages;
        var concern_keys = {
            'pre_paro':  'Paro',
            'pre_sani':  'Sanidad',
            'pre_edu':  'Educación',
            'pre_econom':  'Economía',
            'pre_empleoq':  'Empleo',
            'pre_despobl':  'Despoblación',
            'pre_incendio':  'Incendios'
        };

        /* Carga del mapa */
        var map = L.map('map', {
            zoomControl: true,
            center: [42.725, -7.889],
            zoom: 8,
            minZoom: 8
        });

        L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}.png', {
            attribution: 'CARTO'
        }).addTo(map);

        /* FUNCIONES */
        var refresh = function () {
            sublayer.setSQL("select * from " + table_name  + getGeoFilter());
            refreshGraph();
        };

        //Gréfico de barras agupadas
        function parseData(data) {
            // console.log(data)
            var output = {
                key:"Main title",
                values:[]
            };

            data.rows.forEach(function(item){
                output.values.push({
                    label: item.ds_prov,
                    value: item.pb_pob15
                })
            });
            //We need to wrap output as an array!
            return [output];
        }

        var refreshGraph = function(){
            // vertical bar
            sql.execute("select distinct ds_prov, pb_pob15 from {{table_name}} " + getGeoFilter(), {table_name: table_name})
            .done(function(data) {
                nv.addGraph(function() {
                    var chart = nv.models.discreteBarChart()
                        .color(["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"])
                        .x(function(d) { return d.label })    //Specify the data accessors.
                        .y(function(d) { return d.value })
                        .staggerLabels(true)    //Too many bars and not enough room? Try staggering labels.
                        .tooltips(false)        //Don't show tooltips
                        .showValues(false)       //...instead, show the bar value right on top of each bar.
                        .showXAxis(true)
                        ;


                    d3.select('#chart_pob svg').remove();
                    d3.select('#chart_pob').append('svg')
                        .datum(parseData(data))
                        .call(chart);

                    nv.utils.windowResize(chart.update);

                    return chart;
                });
            });

            // concerns bar
            sql.execute("select avg(pre_paro) as pre_paro, avg(pre_sani) as pre_sani, avg(pre_edu) as pre_edu, avg(pre_econom) as pre_econom, avg(pre_empleoq) as pre_empleoq, avg(pre_despobl) as pre_despobl, avg(pre_incendio) as pre_incendio from {{table_name}}" + getGeoFilter(), {table_name: table_name})
            .done(function(data) {
                var averages = data.rows[0];
                var values = _.map(_.keys(data.rows[0]),function(prop){
                    return {
                        "label" :  concern_keys[prop],
                        "value": averages[prop] - concern_averages[prop]
                    }
                });
                var gr_data = [{"key":"Preocupaciones", "color": "#d67777", values:values }];


                nv.addGraph(function() {
                    var chart = nv.models.multiBarHorizontalChart()
                        .x(function(d) { return d.label })
                        .y(function(d) { return d.value })
                        .margin({top: 20, right: 20, bottom: 20, left: 80})
                        .showValues(true)
                        .tooltips(true)
                        .stacked(true)
                        .showControls(false);

                    chart.yAxis
                        .tickFormat(d3.format(',.2f'));

                    d3.select('#chart_concern svg').remove();
                    d3.select('#chart_concern').append('svg')
                        .datum(gr_data)
                        .call(chart);

                    nv.utils.windowResize(chart.update);

                    return chart;
                  });
            })
        }

        var getGeoFilter = function(){
            var query_sections = []

            _.each(_.keys(geo_filter),function(prop){
                var value = geo_filter[prop];

                if (_.isString(value)){
                    query_sections.push( prop + ' = \'' + value + '\'' );
                }
            });

            return query_sections.length > 0 ? ' where 1=1 and ' + query_sections.join(' and ') : '';
        }



        /* Carga de la capa de CARTO */
        cartodb.createLayer(map, {
            user_name: 'minsait',
            type: 'cartodb',

            sublayers: [{
                sql: 'select * from galicia',
                cartocss: '#layer { polygon-fill: #F00; polygon-opacity: 0.3; line-color: #F00; }',
            }]
        },{https:true})
        .addTo(map)
        .done(function(layer) {
            layer.setInteraction(true);

            sublayer = layer.getSubLayer(0);

            //BUSCAR
            var search_overlay = cdb.vis.Overlay.create('search', map.viz, {});
            search_overlay.show();
            $('#map').append(search_overlay.render().el);

            //BOTONES DE SELECCIÓN DE CAPAS
            // xxx

            //we define the queries that will be performed when we click on the buttons, by modifying the SQL of our layer
            var LayerActionsA = {
                        Capa1: function() {
                        sublayer.set({
                          sql: "SELECT * FROM test_data " + getGeoFilter(),
                        cartocss: "#layer {polygon-fill: #FFFFB2; polygon-opacity: 0.8; line-color: #F5A27A; line-width: 0.5; line-opacity: 0.8;} #layer[ech_16icc <= 25]{polygon-fill: #F5F514;} #layer[ech_16icc <= 10]{polygon-fill: #F5B869} #layer[ech_16icc <= 0]{polygon-fill: #F57A40;} #layer[ech_16icc <= -10]{polygon-fill: #F53D36;}#layer[ech_16icc <= -25]{polygon-fill: #F50024;}",
                            interactivity: ['ds_prov', 'ds_muni']
                        });
                            $('#legend1').show();
                            $('#legend2').hide();
                            $('#legend3').hide();
                            $('#legend4').hide();
                        return true;
                        },

                        Capa2: function() {
                        sublayer.set({
                          sql: "SELECT * FROM test_data" + getGeoFilter(),
                            cartocss: "#layer { polygon-fill: ramp([ind_tparo], (#ecda9a, #f3ad6a, #f97b57, #ee4d5a), quantiles); line-width: 1; line-color: #FFF; line-opacity: 0.5; }",
                            interactivity: ['ind_tparo']
                        });

                        $('#legend1').hide();
                        $('#legend2').show();
                        $('#legend3').hide();
                        $('#legend4').hide();

                        return true;

                                   },
                        Capa3: function() {
                        sublayer.set({
                          sql: "SELECT * FROM test_data" + getGeoFilter(),
                            cartocss: "#layer {polygon-fill: #FFFFB2; polygon-opacity: 0.5; line-color: #D3D3D3; line-width: 0.5; line-opacity: 1;} #layer[pb_esjoven = 'JOVEN']{polygon-fill:#191970} #layer[pb_esjoven = 'NO JOVEN']{polygon-fill:#ADD8E6;}",
                            interactivity: ['ds_prov']
                        });
                        $('#legend1').hide();
                        $('#legend2').hide();
                        $('#legend3').show();
                        $('#legend4').hide();

                        return true;

                                   },
                        Capa4: function() {
                        sublayer.set({
                          sql: "SELECT * FROM test_data" + getGeoFilter(),
                            cartocss: "#layer {polygon-fill: #FFFFB2; polygon-opacity: 0.5; line-color:     #D3D3D3; line-width: 0.5; line-opacity: 0.8;} #layer[el16_pmay = 'PP']{polygon-fill: #00C5FF;} #layer[el16_pmay = 'PSOE']{polygon-fill: #FF0000;} #layer[el16_pmay = 'MAREAS']{polygon-fill: #C500FF;} #layer[el16_pmay = 'BNG'] {polygon-fill: #004DA8;}",
                            interactivity: ['ds_prov']
                        });
                        $('#legend1').hide();
                        $('#legend2').hide();
                        $('#legend3').hide();
                        $('#legend4').show();
                    return true;
                }
            };

            $('#thematic button').click(function() {
                $('#thematic button').removeClass('active')
                $(this).addClass('active');
                $('#legend').hide();
                LayerActionsA[$(this).attr('id')]();
            });

            var infowindow0 = cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(0), ['ds_prov', 'ds_muni', 'ds_comarca', 'ds_concello']);

            // get average concerns and then load graphs

            sql.execute('select avg(pre_paro) as pre_paro ,avg(pre_sani) as pre_sani ,avg(pre_edu) as pre_edu ,avg(pre_econom) as pre_econom ,avg(pre_empleoq) as pre_empleoq ,avg(pre_despobl) as pre_despobl ,avg(pre_incendio) as pre_incendio from {{table_name}}', {table_name: table_name})
            .done(function(data){
                if (data.rows){
                    concern_averages = data.rows[0]
                    refreshGraph();

                    // Click on the first layer
                    $('#Capa1').click();
                };
            })
        });
        // Fin de la carga del mapa


          /* Control del municipio */
        var update_municipality_selector = function () {
            $("#municipality_selector").html('<option value="Todos">Todos</option>');

            sql.execute("select ds_muni from {{table_name}} " + getGeoFilter() + " group by ds_muni order by ds_muni", {table_name: table_name})
            .done(function (data) {
                municipalities = [];
                for (var i = 0; i < data.rows.length; i++) {
                    municipalities.push(data.rows[i].ds_muni);
                    $("#municipality_selector").append('<option value="' + data.rows[i].ds_muni + '">' + data.rows[i].ds_muni + '</option>');
                }
            })
            .error(function(errors) {
                console.log("errors:" + errors);
            });
        };

        /* Control de poblacion */
        var update_poblacion_selector = function () {
            $("#poblacion_selector").html('<option value="Todos">Todos</option>');

            sql.execute("select pb_esjoven from {{table_name}} " + getGeoFilter() + " group by pb_esjoven order by pb_esjoven", {table_name: table_name})
            .done(function (data) {
                poblacion = [];
                for (var i = 0; i < data.rows.length; i++) {
                    poblacion.push(data.rows[i].pb_esjoven);
                    $("#poblacion_selector").append('<option value="' + data.rows[i].pb_esjoven + '">' + data.rows[i].pb_esjoven + '</option>');
                }
            })
            .error(function(errors) {
                console.log("errors:" + errors);
            });
        };

        /* Control vulnerable */
         var update_vulnera_selector = function () {
            $("#vulnera_selector").html('<option value="Todos">Todos</option>');

            sql.execute("select vulne1 from {{table_name}} " + getGeoFilter() + " group by vulne1 order by vulne1", {table_name: table_name})
            .done(function (data) {
                vulnera = [];
                for (var i = 0; i < data.rows.length; i++) {
                    vulnera.push(data.rows[i].vulne1);
                    $("#vulnera_selector").append('<option value="' + data.rows[i].vulne1 + '">' + data.rows[i].vulne1 + '</option>');
                }
            })
            .error(function(errors) {
                console.log("errors:" + errors);
            });
        };
        /* CARGA DEL SELECTOR DE PROVINCIAS */
        sql.execute("select ds_prov from {{table_name}} group by ds_prov order by ds_prov", {table_name: table_name})
        .done(function (data) {
            for (var i = 0; i < data.rows.length; i++) {
                provinces.push(data.rows[i].ds_prov);
                $("#province_selector").append('<option value="' + data.rows[i].ds_prov + '">' + data.rows[i].ds_prov + '</option>');
            }

        })
        .error(function(errors) {
            console.log("errors:" + errors);
        });

        /* CARGA DEL SELECTOR DE MUNICIPIOS */
        update_municipality_selector();
       /* CARGA DEL SELECTOR DE POBLACIÓN */
        update_poblacion_selector();
         /* CARGA VULNERABILIDAD */
        update_vulnera_selector();

        /* EVENTOS SELECTORES */

        $('#province_selector').change(function() {
            var province = $(this).val();
            if (province == "A Coruña','Lugo','Pontevedra','Ourense") {
                geo_filter['ds_prov'] = false;
            } else {
                geo_filter['ds_prov'] = province;
            }
            refresh();
            update_municipality_selector();
            //update_poblacion_selector();
        });

        $('#municipality_selector').change(function() {
            var municipality = $(this).val();
            if (municipality == "Todos") {
                geo_filter['ds_muni'] = false;
            } else {
                geo_filter['ds_muni'] =  municipality;
            }
            refresh();
        });

        $('#poblacion_selector').change(function() {
            var poblacion = $(this).val();
            if (poblacion == "Todos") {
                geo_filter['pb_esjoven'] = false;
            } else {
                geo_filter['pb_esjoven'] = poblacion;
            }
            refresh();
        });

         $('#vulnera_selector').change(function() {
            var vulnera = $(this).val();
            if (vulnera == "Todos") {
                geo_filter['vulne1'] = false;
            } else {
                geo_filter['vulne1'] = vulnera;
            }
            refresh();
        });
    </script>


    </body>
</html>
