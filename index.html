<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="generator" content="CoffeeCup HTML Editor (www.coffeecup.com)">
    <meta name="dcterms.created" content="lun, 20 feb 2017 17:46:37 GMT">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <title></title>

    <!--[if IE]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
<!DOCTYPE html>
<html>
    <head>
        <title>MAPA INICIAL</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
        <!--LIBRERIAS GRÁFICOS -->

        <script src="scripts/d3.js" charset="utf-8"></script>
        <link href="scripts/nv.css" rel="stylesheet">
        <script src="scripts/nv.js"></script>
        <meta name="viewport" content="initial-scale = 1, user-scalable = no">

        <!--LIBRERIAS COMUNES -->
        <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css">
        <!-- include cartodb.js library -->
        <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>

        <!--ESTILO DEL MAPA Y SUS HERRAMIENTAS -->
        <style>

            html,
            body,
            #map {
                height: 100%;
                width: 92%;
                padding: 0;
                margin: 0;
            }
             /*
            .ui-autocomplete-loading {
             background: white url('images/ui-anim_basic_16x16.gif') right center no-repeat;
            }  */

        </style>

            <!--ESTILO DE LOS BOTONES -->
         <style>
           #selector_menu {
            position: absolute;
            top: 20px;
            left: 50px;
            z-index: 9000;
            }

           #menu {
                position: absolute;
                top: 240px;
                right: 275px;
                width: 80px;
                height: 10px;
                background: transparent;
                z-index: 10;
            }

            #menu a {
            display: inline-block;
            padding: 15px 25px;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            outline: none;
            color: #fff;
            background-color:#8B0000;
            border: none;
            border-radius: 15px;
            box-shadow: 0 3px #999;
            width: 60px;
            padding: 10px;
            }

            #menu a.selected,
            #menu a:hover {
                background-color: #556B2F;
            }

            #legend{
                top: 200px;
                right: 10px;
                bottom: inherit;
                right: inherit;
            }
            </style>

        <!--ESTILO DE LOS GRÁFICOS -->
        <style>
            #chart {
                height: 200px;
                margin: 5px;
                width: 300px;
                position: absolute;
                top: 10px;
                right:10px;
                z-index: 1;
         }
            </style>

        <!-- Buscar auto completar -->
        <script>
        </script>
    </head>
    <body>

        <div id="chart"></div>


        <!-- DIV MAPA -->
        <div id="map" class="mapita" style="position: relative; cursor: auto;" tabindex="0"></div>

        <!-- LEYENDA -->
        <div class='cartodb-legend density' style="display: none;" id="legend1">
            <div class="legend-title" style="color:#284a59">Ind. Confianza Ciudadano</div>
            <ul>
                <li class="min"> Muy Baja </li>
                <li class="max"> Muy Alta </li>

                <li class="graph leg" style="border-radius: 0; border:none">
                    <div class="colors">
                        <div class="quartile" style="background-color:#F50024"></div>
                        <div class="quartile" style="background-color:#F53D36"></div>
                        <div class="quartile" style="background-color:#F57A40"></div>
                        <div class="quartile" style="background-color:#F5B869"></div>
                        <div class="quartile" style="background-color:#F5F514"></div>
                     </div>
                     <div class="colors" style="font-weight:normal; text-align: center">
                        <div class="quartile" style="padding-top: 5px"></div>
                        <div class="quartile" style="padding-top: 5px"></div>
                        <div class="quartile" style="padding-top: 5px"></div>
                        <div class="quartile" style="padding-top: 5px"></div>
                        <div class="quartile" style="padding-top: 5px"></div>
                     </div>
                </li>
            </ul>
        </div>

        <div class='cartodb-legend category' style="display: none;" id="legend2">
            <div class="legend-title" style="color:#284a59">Capa2</div>
            <ul>
                <li><div class="bullet" style="background-color:#FFFF00">
                <li><div class="bullet" style="background-color:#C84023">
                <li><div class="bullet" style="background-color:#C97130">
                <li><div class="bullet" style="background-color:#B41618">
            </ul>
        </div>

        <div class='cartodb-legend category' style="display: none;" id="legend3">
            <div class="legend-title" style="color:#284a59">Jovenes</div>
            <ul>
                <li><div class="bullet" style="background-color:#191970"></div>JOVEN</li>
                <li><div class="bullet" style="background-color:#ADD8E6"></div>NO JOVEN</li>

            </ul>
        </div>

        <div class='cartodb-legend category' style="display: none;" id="legend4">
            <div class="legend-title" style="color:#284a59">Voto Mayoritario '16</div>
            <ul>
                <li><div class="bullet" style="background-color:#00C5FF"></div>PP</li>
                <li><div class="bullet" style="background-color:#FF0000"></div>PSOE</li>
                <li><div class="bullet" style="background-color:#C500FF"></div>MAREAS</li>
                <li><div class="bullet" style="background-color:#004DA8"></div>BNG</li>
            </ul>
        </div>

        <!-- DIV SELECTORES-->
        <div id="selector_menu">
            <table border="0" width="100px"   align="center" cellpadding="2px"  >
                <tr>
                    <td colspan="2" style="f"><p style="color: white">Filtro Geográfico</p></td>
                </tr>
                <tr>
                    <td> <p style="color: white">Provincias</p></td>
                    <td>
                        <select id="province_selector">
                            <option value="A Coruña','Lugo','Pontevedra','Ourense">Todas</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td><p style="color: white">Municipios</p></td>
                        <td>
                        <select id="municipality_selector"> </select>
                    </td>
                </tr>
                  <tr>
                    <td colspan="2" style="f"><p style="color: white">Filtro Prospección</p></td>
                </tr>
                <tr>
                    <td> <p style="color: white">Población</p></td>
                    <td>
                        <select id="poblacion_selector">

                        </select>
                    </td>
                </tr>
                <tr>
                    <td><p style="color: white">Vulnerabilidad</p></td>
                        <td>
                        <select id="vulnera_selector">

                        </select>
                    </td>
                </tr>
            </table>
        </div>

       <!-- DIV BOTONES-->
       <!-- DIV BOTONES-->
        <div id="menu">
            <ul> <a href="#Capa1" id="Capa1" class="button Capa1">ICC</a>  </ul>
            <ul> <a href="#Capa2" id="Capa2" class="button Capa2">Capa2</a>  </ul>
            <ul> <a href="#Capa3" id="Capa3" class="button Capa3">Jovenes</a>  </ul>
            <ul> <a href="#Capa4" id="Capa4" class="button Capa4">Voto'16</a>  </ul>
        </div>

         <!-- Recupera la provincia de la selección-->

        <script>

         /* var search_text = (function() {
            sql.execute("select distinct ds_prov, pb_pob15 from {{table_name}} " + geo_filter, {table_name: table_name});
            var Recg_prov = ( search_text .val());
            alert(Recg_prov);



        var kk = $('#province_selector').val();
        if (kk == "Todas"){
          Prov = "A Coruña','Lugo','Pontevedra','Ourense'";
          alert (kk)
        };
      };*/

        // GLOBALES

        var sql = new cartodb.SQL({ user: 'minsait' });
        var table_name = "test_data";
        var provinces = [];
        var municipalities = [];
        var geo_filter = "";
        var sublayer;
        var nvChart;

        /* Carga del mapa */
        var map = L.map('map', {
            zoomControl: true,
            center: [42.725, -7.889],
            zoom: 8,
            minZoom: 8
        });

        L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}.png', {
            attribution: 'CARTO'
        }).addTo(map);



        /* FUNCIONES */
        var refresh = function () {
            sublayer.setSQL("select * from " + table_name + geo_filter);
            refreshGraph();
        };


        /* No funciona lo programe en otro lado y falta añadir imangen estilo y referencia de libreria*/
        function initAutocomplete() {
            function log(message) {
                $("<div>").text(message).prependTo("#log");
                $("#log").scrollTop(0);
            }

            $(".cartodb-searchbox .text").autocomplete({
                source: function(request, response) {
                    var s;
                    sql.execute("select distinct ds_muni, ds_prov from {{table_name}} where ds_muni ilike '{{request_term}}%'", {request_term: request.term}).done(function(data) {
                        response(data.rows.map(function(r) {
                            return {
                                label: r.ds_muni + ', ' + r.ds_prov,
                                value: r.ds_muniunit
                            };
                        }));
                    });
                },
                minLength: 2,
                select: function(event, ui) {
                    log(ui.item ?
                        "Selected: " + ui.item.value :
                        "Nothing selected, input was " + this.value);
                }
            });
        }

        //Gréfico de barras agupadas
        function parseData(data) {
            console.log('parseData')
            // console.log(data)
            var output = {
                key:"Main title",
                values:[]
            };

            data.rows.forEach(function(item){
                output.values.push({
                    label: item.ds_prov,
                    value: item.pb_pob15
                })
            });
            //We need to wrap output as an array!
            return [output];
        }

        var refreshGraph = function(){
           //sql.execute("select distinct ds_prov, pb_pob15 from {{table_name}} where ds_prov ilike '" +  Recg_prov + "'"), {table_name: table_name})
           sql.execute("select distinct ds_prov, pb_pob15 from {{table_name}} " + geo_filter, {table_name: table_name})
          .done(function(data) {
                nv.addGraph(function() {
                    var chart = nv.models.discreteBarChart()
                        .color(["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"])
                        .x(function(d) { return d.label })    //Specify the data accessors.
                        .y(function(d) { return d.value })
                        .staggerLabels(true)    //Too many bars and not enough room? Try staggering labels.
                        .tooltips(true)        //Don't show tooltips
                       // .showValues(true)       //...instead, show the bar value right on top of each bar.
                        .showXAxis(true)
                        ;


                    d3.select('#chart svg').remove();
                    d3.select('#chart').append('svg')
                        .datum(parseData(data))
                        .call(chart);

                    nv.utils.windowResize(chart.update);

                    return chart;
                });
          });
        }



        /* Carga de la capa de CARTO */
        cartodb.createLayer(map, {
            user_name: 'minsait',
            type: 'cartodb',

            sublayers: [{
                sql: 'select * from galicia',
                cartocss: '#layer { polygon-fill: #F00; polygon-opacity: 0.3; line-color: #F00; }',
            }]
        },{https:true})
        .addTo(map)
        .done(function(layer) {
            layer.setInteraction(true);

            sublayer = layer.getSubLayer(0);

            //BUSCAR
            var search_overlay = cdb.vis.Overlay.create('search', map.viz, {});
            search_overlay.show();
            $('#map').append(search_overlay.render().el);
            initAutocomplete();


            //CAJA DE INFORMACIÓN GENERAL ON OVER
            var infoBox = layer.leafletMap.viz.addOverlay({
                type: 'infobox',
                layer: layer,
                template: '<div class="cartodb-tooltip-content-wrapper"><h2>{{name}}</h2> <h3>Provincia</h3> <p>{{ds_prov}}<span> </span></p> </div>',
                width: 150,
                position: 'bottom|left'
            });
            $('box').append(infoBox.render().el);



            //BOTONES DE SELECCIÓN DE CAPAS
            // xxx

            //we define the queries that will be performed when we click on the buttons, by modifying the SQL of our layer
            var LayerActionsA = {
                        Capa1: function() {
                        sublayer.set({
                        cartocss: "#layer {polygon-fill: #FFFFB2; polygon-opacity: 0.8; line-color: #F5A27A; line-width: 0.5; line-opacity: 0.8;} #layer[ech_16icc <= 25]{polygon-fill: #F5F514;} #layer[ech_16icc <= 10]{polygon-fill: #F5B869} #layer[ech_16icc <= 0]{polygon-fill: #F57A40;} #layer[ech_16icc <= -10]{polygon-fill: #F53D36;}#layer[ech_16icc <= -25]{polygon-fill: #F50024;}",
                            interactivity: ['ds_prov', 'ds_muni']
                        });
                            $('#legend1').show();
                            $('#legend2').hide();
                            $('#legend3').hide();
                            $('#legend4').hide();
                        return true;
                        },

                        Capa2: function() {
                        sublayer.set({
                            cartocss: "#layer {polygon-fill: #FFFFB2; polygon-opacity: 0.8; line-color:     #D3D3D3; line-width: 0.5; line-opacity: 1;} #layer[cd_prov = '15']{polygon-fill: #FFFF00;} #layer[cd_prov = '36']{polygon-fill: #E31A1C;} #layer[cd_prov = '27']{polygon-fill: #FC4E2A;} #layer[cd_prov = '32'] {polygon-fill: #FD8D3C;}",
                            interactivity: ['ds_prov']
                        });
                        $('#legend1').hide();
                        $('#legend2').show();
                        $('#legend3').hide();
                        $('#legend4').hide();

                        return true;

                                   },
                        Capa3: function() {
                        sublayer.set({
                            cartocss: "#layer {polygon-fill: #FFFFB2; polygon-opacity: 0.5; line-color:     #D3D3D3; line-width: 0.5; line-opacity: 1;} #layer[pb_esjoven = 'JOVEN']{polygon-fill:#191970} #layer[pb_esjoven = 'NO JOVEN']{polygon-fill:#ADD8E6;}",
                            interactivity: ['ds_prov']
                        });
                        $('#legend1').hide();
                        $('#legend2').hide();
                        $('#legend3').show();
                        $('#legend4').hide();

                        return true;

                                   },
                        Capa4: function() {
                        sublayer.set({
                            cartocss: "#layer {polygon-fill: #FFFFB2; polygon-opacity: 0.5; line-color:     #D3D3D3; line-width: 0.5; line-opacity: 0.8;} #layer[el16_pmay = 'PP']{polygon-fill: #00C5FF;} #layer[el16_pmay = 'PSOE']{polygon-fill: #FF0000;} #layer[el16_pmay = 'MAREAS']{polygon-fill: #C500FF;} #layer[el16_pmay = 'BNG'] {polygon-fill: #004DA8;}",
                            interactivity: ['ds_prov']
                        });
                        $('#legend1').hide();
                        $('#legend2').hide();
                        $('#legend3').hide();
                        $('#legend4').show();
                    return true;
                }
            };

            $('.button').click(function() {
                $('.button').removeClass('selected');
                $(this).addClass('selected');
                $('#legend').hide();
                LayerActionsA[$(this).attr('id')]();
            });

           console.log(layer.getSubLayer(0));

            layer.getSubLayer(0).on('featureClick',
                function(e, pos, latlng, data) {
                    console.log(data);
                });
            var infowindow0 = cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(0), ['ds_prov', 'ds_muni', 'ds_comarca', 'ds_concello']);

            refreshGraph();
        });
        // Fin de la carga del mapa


          /* Control del municipio */
        var update_municipality_selector = function () {
            $("#municipality_selector").html('<option value="Todos">Todos</option>');

            sql.execute("select ds_muni from {{table_name}}" + geo_filter + " group by ds_muni order by ds_muni", {table_name: table_name})
            .done(function (data) {
                municipalities = [];
                for (var i = 0; i < data.rows.length; i++) {
                    municipalities.push(data.rows[i].ds_muni);
                    $("#municipality_selector").append('<option value="' + data.rows[i].ds_muni + '">' + data.rows[i].ds_muni + '</option>');
                }
            })
            .error(function(errors) {
                console.log("errors:" + errors);
            });
        };

        /* Control de poblacion */
        var update_poblacion_selector = function () {
            $("#poblacion_selector").html('<option value="Todos">Todos</option>');

            sql.execute("select pb_esjoven from {{table_name}}" + geo_filter + " group by pb_esjoven order by pb_esjoven", {table_name: table_name})
            .done(function (data) {
                poblacion = [];
                for (var i = 0; i < data.rows.length; i++) {
                    poblacion.push(data.rows[i].pb_esjoven);
                    $("#poblacion_selector").append('<option value="' + data.rows[i].pb_esjoven + '">' + data.rows[i].pb_esjoven + '</option>');
                }
            })
            .error(function(errors) {
                console.log("errors:" + errors);
            });
        };

        /* Control vulnerable */
         var update_vulnera_selector = function () {
            $("#vulnera_selector").html('<option value="Todos">Todos</option>');

            sql.execute("select vulne1 from {{table_name}}" + geo_filter + " group by vulne1 order by vulne1", {table_name: table_name})
            .done(function (data) {
                vulnera = [];
                for (var i = 0; i < data.rows.length; i++) {
                    vulnera.push(data.rows[i].vulne1);
                    $("#vulnera_selector").append('<option value="' + data.rows[i].vulne1 + '">' + data.rows[i].vulne1 + '</option>');
                }
            })
            .error(function(errors) {
                console.log("errors:" + errors);
            });
        };
        /* CARGA DEL SELECTOR DE PROVINCIAS */
        sql.execute("select ds_prov from {{table_name}} group by ds_prov order by ds_prov", {table_name: table_name})
        .done(function (data) {
            for (var i = 0; i < data.rows.length; i++) {
                provinces.push(data.rows[i].ds_prov);
                $("#province_selector").append('<option value="' + data.rows[i].ds_prov + '">' + data.rows[i].ds_prov + '</option>');
            }

        })
        .error(function(errors) {
            console.log("errors:" + errors);
        });

        /* CARGA DEL SELECTOR DE MUNICIPIOS */
        update_municipality_selector();
       /* CARGA DEL SELECTOR DE POBLACIÓN */
        update_poblacion_selector();
         /* CARGA VULNERABILIDAD */
        update_vulnera_selector();

        /* EVENTOS SELECTORES */
        $('#province_selector').change(function() {
            var province = $(this).val();
            if (province == "A Coruña','Lugo','Pontevedra','Ourense") {
                            geo_filter = "";

            } else {
                geo_filter = " where ds_prov = '" + $(this).val() + "'";

            }
            refresh();
            update_municipality_selector();
            update_poblacion_selector();
        });

        $('#municipality_selector').change(function() {
            var municipality = $(this).val();
            if (municipality == "Todos") {
                geo_filter = "";
                refresh();
            } else {
                geo_filter = " where ds_muni = '" + $(this).val() + "'";
                refresh();
            }
        });

        $('#poblacion_selector').change(function() {
            var poblacion = $(this).val();
            if (poblacion == "Todos") {
                geo_filter = "";
                refresh();

            } else {
                geo_filter = " where pb_esjoven = '" + $(this).val() + "' and ds_prov in  ('" +  $('#province_selector').val() + "')";
                alert(geo_filter);
                refresh();


            }
          });

            $('#vulnera_selector').change(function() {
            var vulnera = $(this).val();
            if (vulnera == "Todos") {
                geo_filter = "";
                refresh();

            } else {
                geo_filter = " where vulne1 = '" + $(this).val() + "' and ds_prov in  ('" +  $('#province_selector').val() + "')";
                alert(geo_filter);
                refresh();


            }
          });
    </script>


    </body>
</html>


